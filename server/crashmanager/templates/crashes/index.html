{% extends 'layouts/layout_base.html' %}

{% block body_content %}
<div class="panel panel-default">
	<div class="panel-heading"><i class="glyphicon glyphicon-list-alt"></i> Crashes</div>
	{% if isQuery %}
	<div class="panel-body">
        {% if error_message %}<div class="alert alert-warning" role="alert">{{ error_message }}</div>{% endif %}

            <form action="{% url 'crashmanager:querycrashes' %}" method="post">
            {% csrf_token %}
            <label for="id_query">Search Query</label><br/>
	    
	    <textarea id="id_query" rows={{ query_lines|length }} class="form-control" name="query" spellcheck='false'>{{ query_lines|join:"&#10;" }}</textarea>

            <input type="submit" name="submit_query" value="Search" class="btn btn-default"/>

	    {% if query_lines %}
	     <a href="{% url 'crashmanager:querycrashes' %}?query={{ urlQuery }}">Bookmark this query</a>
	    {% endif %}

        </form>
	</div>
	{% endif %}
	<div class="panel-body">
		<p>
		{% if isSearch or isQuery %}
			Your search matched {{ crashlist.count }} entries in database.
		{% elif isAll %}
			Displaying all {{ crashlist.count }} entries in database.
		{% elif isWatch %}
			Displaying {{ crashlist.count }} new entries in bucket {{ bucket.pk }}.
			<form action="{% url 'crashmanager:sigwatchnew' %}" method="post">
			{% csrf_token %}
			<input type="hidden" name="bucket" value="{{ bucket.pk }}"/>
			<input type="hidden" name="crash" value="{{ latestCrash }}"/>
			<input type="submit" name="submit" value="Mark All Viewed" title="Continue watching for new crashes" class="btn btn-default"/>
			</form>
		{% else %}
			There are {{ crashlist.count }} unbucketed entries in the database.
			<div class="btn-group" role="group">
				<a href="{% url 'crashmanager:autoassign' %}" class="btn btn-default">Assign <span class="badge">{{ crashlist.count }}</span></a>
				<a href="{% url 'crashmanager:allcrashes' %}" class="btn btn-default">Show All</a>
			</div>
		{% endif %}
	        </p>
		{% if crashlist.paginator %}
		<div class="pagination">
		    <span class="step-links">
			{% if crashlist.has_previous %}
			    <a href="?{{crashlist.paginator_query.urlencode}}&page={{ crashlist.previous_page_number }}" class="glyphicon glyphicon-chevron-left"></a>
			{% endif %}

			<span class="current">
			    Page {{ crashlist.number }} of {{ crashlist.paginator.num_pages }}.
			</span>

			{% if crashlist.has_next %}
			    <a href="?{{crashlist.paginator_query.urlencode}}&page={{ crashlist.next_page_number }}" data-toggle="tooltip" data-placement="top" title="Next" class="glyphicon glyphicon-chevron-right" style="color:dimgray"></a>
			{% endif %}
		    </span>
		</div>
		{% endif %}
	</div>
	<table class="table table-condensed table-hover table-bordered table-db">
		<thead>
			<tr>
				<th style="width: 25px;">ID</th>
				<th style="width: 50px;">Date Added</th>
				<th style="width: 25px;">Bucket</th>
				<th style="width: 100px;">Short Signature</th>
				<th style="width: 40px;">Crash Address</th>
				<th style="width: 50px;">Test Status</th>
				<th style="width: 50px;">Product</th>
				<th style="width: 50px;">Version</th>
				<th style="width: 25px;">Platform</th>
				<th style="width: 25px;">OS</th>
				<th style="width: 40px;">Tool</th>
			</tr>
		</thead>
		<tbody>
	  {% for entry in crashlist %}<tr class="{% cycle 'odd' 'even' %}">
	<td><a href="{% url 'crashmanager:crashview' entry.pk %}">{{ entry.pk }}</a></td>
		  <td>{{ entry.created|date:"r" }}</td>
	<td>
	{% if entry.bucket %}
		<a href="{% url 'crashmanager:sigview' entry.bucket.pk %}">{{ entry.bucket.pk }} </a>
	{% else %}
	        {% if not entry.triagedOnce %}
		<span class="glyphicon glyphicon-hourglass" data-toggle="tooltip" data-placement="top" title="This item hasn't been triaged yet by the server."></span>
		{% endif %}
		<a href="{% url 'crashmanager:signew' %}?crashid={{ entry.pk }}" data-toggle="tooltip" data-placement="top" title="Add" class="glyphicon glyphicon-oil" style="color:dimgray"></a>
		<a href="{% url 'crashmanager:findsigs' entry.pk %}" data-toggle="tooltip" data-placement="top" title="Search" class="glyphicon glyphicon-search" style="color:dimgray"></a>
	{% endif %}
	</td>
	<td>{{ entry.shortSignature|escape }}</td>
	<td>{{ entry.crashAddress|escape }}</td>
	<td>
		{% if entry.testcase %}
			<a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&testcase__quality={{ entry.testcase.quality|urlencode }}">Q{{entry.testcase.quality}}</a>
			{{ entry.testcase.size }}
			{% if entry.testcase.isBinary %}
				(binary)
			{% endif %}
		{% else %}
			No test
		{% endif %}
	</td>
	<td><a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&product__name={{ entry.product.name|urlencode }}">{{ entry.product.name|escape }}</a></td>
	<td><a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&product__version={{ entry.product.version|urlencode }}">{{ entry.product.version|escape }}</a></td>
	<td><a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&platform__name={{ entry.platform.name|urlencode }}">{{ entry.platform.name|escape }}</a></td>
	<td><a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&os__name={{ entry.os.name|urlencode }}">
		{% if entry.os.name|escape == 'linux' %}
			<img width="16px" height="16px" alt="Linux" src="{{STATIC_URL}}img/os/linux.png"/>
		{% elif entry.os.name|escape == 'macosx' %}
			<img width="16px" height="16px" alt="MacOS" src="{{STATIC_URL}}img/os/macosx.png"/>
		{% elif entry.os.name|escape == 'windows' %}
			<img width="16px" height="16px" alt="Windows" src="{{STATIC_URL}}img/os/windows.png"/>
		{% elif entry.os.name|escape == 'android' %}
			<img width="16px" height="16px" alt="Android" src="{{STATIC_URL}}img/os/android.png"/>
		{% else %}
			{{ entry.os.name|escape }}
		{% endif %}
	</a></td>
	<td><a title="Add to search" href="{{request.path}}?{{request.GET.urlencode}}&tool__name={{ entry.tool.name|urlencode }}">{{ entry.tool.name|escape }}</a></td>
			</tr>{% endfor %}
		</tbody>
	</table>
</div>
{% endblock body_content %}
